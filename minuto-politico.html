<!DOCTYPE html>
<html lang="it" data-theme="auto">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minuto Politico</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --it:       #b83232;
  --eu:       #1b4f72;
  --usa:      #6b5900;
  --serif:    'Lora', Georgia, serif;
  --sans:     'DM Sans', system-ui, sans-serif;
  --r:        2px;
}

/* LIGHT */
[data-theme="light"], [data-theme="auto"] {
  --bg:       #f8f6f1;
  --bg2:      #eeebe4;
  --surf:     #ffffff;
  --bord:     #ddd8cf;
  --bord2:    #c9c2b5;
  --txt:      #18160f;
  --txt2:     #4c4538;
  --muted:    #90897e;
  --hbg:      rgba(248,246,241,.97);
  --tag-it:   #f9e8e8;
  --tag-eu:   #e6eff8;
  --tag-usa:  #faf5e0;
  --sh:       0 1px 5px rgba(0,0,0,.07);
  --sh2:      0 4px 22px rgba(0,0,0,.10);
  --trans-badge-bg: #f0ece3;
  --trans-badge-c:  #7a7060;
}
@media (prefers-color-scheme: dark) {
  [data-theme="auto"] {
    --bg:       #100f0a;
    --bg2:      #171510;
    --surf:     #1c1a14;
    --bord:     #2b2820;
    --bord2:    #3a3628;
    --txt:      #e4dccb;
    --txt2:     #9e9580;
    --muted:    #5e5748;
    --hbg:      rgba(16,15,10,.97);
    --tag-it:   rgba(184,50,50,.16);
    --tag-eu:   rgba(27,79,114,.2);
    --tag-usa:  rgba(107,89,0,.2);
    --sh:       0 1px 5px rgba(0,0,0,.3);
    --sh2:      0 4px 22px rgba(0,0,0,.45);
    --trans-badge-bg: rgba(255,255,255,.06);
    --trans-badge-c:  #6e6558;
  }
}
[data-theme="dark"] {
  --bg:       #100f0a;
  --bg2:      #171510;
  --surf:     #1c1a14;
  --bord:     #2b2820;
  --bord2:    #3a3628;
  --txt:      #e4dccb;
  --txt2:     #9e9580;
  --muted:    #5e5748;
  --hbg:      rgba(16,15,10,.97);
  --tag-it:   rgba(184,50,50,.16);
  --tag-eu:   rgba(27,79,114,.2);
  --tag-usa:  rgba(107,89,0,.2);
  --sh:       0 1px 5px rgba(0,0,0,.3);
  --sh2:      0 4px 22px rgba(0,0,0,.45);
  --trans-badge-bg: rgba(255,255,255,.06);
  --trans-badge-c:  #6e6558;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { -webkit-text-size-adjust:100%; scroll-behavior:smooth; }
body {
  background:var(--bg); color:var(--txt);
  font-family:var(--serif); line-height:1.6;
  min-height:100vh; transition:background .25s, color .25s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  background:var(--hbg); border-bottom:1px solid var(--bord);
  position:sticky; top:0; z-index:100;
  backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
}
.h-wrap { max-width:1200px; margin:0 auto; padding:0 1.5rem; }

.h-top {
  display:flex; align-items:center; justify-content:space-between;
  gap:.75rem; padding:.65rem 0;
  border-bottom:1px solid var(--bord);
}

/* â”€â”€ Brand â”€â”€ */
.brand {
  font-family:var(--sans); font-weight:700;
  font-size:clamp(1.1rem,3.8vw,1.55rem);
  letter-spacing:-.03em; line-height:1;
  color:var(--txt); white-space:nowrap; user-select:none;
}
.brand .dot { color:var(--it); }

/* â”€â”€ Controls â”€â”€ */
.h-ctrl { display:flex; align-items:center; gap:.55rem; flex-shrink:0; }

.s-dot {
  width:6px; height:6px; border-radius:50%;
  background:var(--it); flex-shrink:0;
  animation:blink 2s infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.2} }
#status-txt { font-family:var(--sans); font-size:.68rem; color:var(--muted); }

/* Theme toggle */
.theme-toggle {
  display:flex; background:var(--bg2); border:1px solid var(--bord);
  border-radius:24px; padding:2px; gap:1px;
}
.t-btn {
  background:none; border:none; cursor:pointer;
  padding:.28rem .46rem; border-radius:20px;
  font-size:.75rem; color:var(--muted); transition:all .15s; line-height:1;
}
.t-btn.active { background:var(--surf); color:var(--txt); box-shadow:var(--sh); }
.t-btn:hover:not(.active) { color:var(--txt2); }

/* Refresh */
.refresh-btn {
  font-family:var(--sans); font-size:.72rem; font-weight:600; letter-spacing:.02em;
  background:var(--it); color:#fff; border:none;
  padding:.42rem .9rem; border-radius:var(--r);
  cursor:pointer; transition:opacity .2s;
  display:flex; align-items:center; gap:.32rem; white-space:nowrap;
}
.refresh-btn:hover { opacity:.85; }
.refresh-btn:disabled { opacity:.35; cursor:not-allowed; }
.r-icon { display:inline-block; }
.refresh-btn.loading .r-icon { animation:spin 1s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

/* â”€â”€ Tabs â”€â”€ */
.tabs {
  display:flex; overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none;
}
.tabs::-webkit-scrollbar { display:none; }
.tab {
  font-family:var(--sans); font-size:.73rem; font-weight:500;
  letter-spacing:.02em; padding:.62rem 1rem .58rem;
  border:none; background:none; color:var(--muted);
  cursor:pointer; border-bottom:2px solid transparent;
  transition:all .15s; white-space:nowrap; flex-shrink:0;
}
.tab:hover { color:var(--txt2); }
.tab.active              { color:var(--txt);  border-bottom-color:var(--txt); }
.tab[data-cat="it"].active  { color:var(--it);  border-bottom-color:var(--it); }
.tab[data-cat="eu"].active  { color:var(--eu);  border-bottom-color:var(--eu); }
.tab[data-cat="usa"].active { color:var(--usa); border-bottom-color:var(--usa); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
main { max-width:1200px; margin:0 auto; padding:2rem 1.5rem; }

/* â”€â”€ Loading â”€â”€ */
#loading {
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; min-height:58vh; gap:1.5rem; text-align:center;
}
.l-logo {
  font-family:var(--sans); font-size:clamp(2rem,8vw,3.2rem);
  font-weight:700; letter-spacing:-.04em;
  color:var(--bord2); animation:lp 1.6s ease infinite;
}
.l-logo .dot { color:var(--it); }
@keyframes lp { 0%,100%{opacity:.2} 50%{opacity:.7} }
.prog { width:160px; height:2px; background:var(--bord); overflow:hidden; border-radius:2px; }
.prog-fill { height:100%; background:var(--it); animation:pf 1.4s ease infinite; }
@keyframes pf { 0%{width:0;transform:translateX(0)} 50%{width:55%} 100%{width:100%;transform:translateX(110%)} }
.l-msg { font-family:var(--sans); font-size:.78rem; color:var(--muted); }

/* â”€â”€ Error â”€â”€ */
#error {
  display:none; flex-direction:column; align-items:center;
  justify-content:center; min-height:50vh;
  gap:1rem; text-align:center; padding:2rem;
}
.e-icon { font-size:2.2rem; opacity:.25; }
.e-title { font-family:var(--sans); font-size:1.3rem; font-weight:700; }
.e-msg { font-family:var(--sans); font-size:.83rem; color:var(--muted); max-width:360px; line-height:1.75; }
.btn-retry {
  font-family:var(--sans); font-size:.73rem; font-weight:600;
  background:var(--it); color:#fff; border:none;
  padding:.55rem 1.3rem; border-radius:var(--r); cursor:pointer; margin-top:.5rem;
}

#content { display:none; }

/* â”€â”€ Section header â”€â”€ */
.sec-hd {
  display:flex; align-items:center; gap:.8rem;
  padding-bottom:.6rem; margin-bottom:1.75rem; margin-top:3rem;
  border-bottom:2px solid var(--bord);
}
.sec-hd:first-child { margin-top:0; }
.sec-hd.it  { border-bottom-color:var(--it); }
.sec-hd.eu  { border-bottom-color:var(--eu); }
.sec-hd.usa { border-bottom-color:var(--usa); }

.sec-icon {
  font-family:var(--sans); font-size:.65rem; font-weight:700;
  letter-spacing:.12em; text-transform:uppercase;
  padding:.2rem .5rem; border-radius:var(--r);
  line-height:1.4;
}
.sec-icon.it  { background:var(--tag-it);  color:var(--it);  }
.sec-icon.eu  { background:var(--tag-eu);  color:var(--eu);  }
.sec-icon.usa { background:var(--tag-usa); color:var(--usa); }

.sec-title {
  font-family:var(--sans); font-size:1.1rem; font-weight:700;
  letter-spacing:-.02em; color:var(--txt);
}
.sec-line { flex:1; height:1px; background:var(--bord); }
.sec-count { font-family:var(--sans); font-size:.66rem; color:var(--muted); }

/* â”€â”€ Source badge â”€â”€ */
.sbadge {
  display:inline-flex; align-items:center; gap:.3rem;
  font-family:var(--sans); font-size:.62rem; font-weight:600;
  letter-spacing:.05em; text-transform:uppercase;
  padding:.13rem .46rem; border-radius:var(--r); margin-bottom:.52rem;
}
.sbadge.it  { background:var(--tag-it);  color:var(--it);  }
.sbadge.eu  { background:var(--tag-eu);  color:var(--eu);  }
.sbadge.usa { background:var(--tag-usa); color:var(--usa); }

/* Translation badge */
.trans-badge {
  display:inline-flex; align-items:center; gap:.25rem;
  font-family:var(--sans); font-size:.58rem; font-weight:500;
  letter-spacing:.04em; text-transform:uppercase;
  padding:.1rem .4rem; border-radius:var(--r);
  background:var(--trans-badge-bg); color:var(--trans-badge-c);
  vertical-align:middle; margin-left:.3rem;
}

/* â”€â”€ Hero card â”€â”€ */
.hero {
  background:var(--surf); border:1px solid var(--bord);
  border-radius:var(--r); padding:1.6rem;
  margin-bottom:1.25rem; cursor:pointer;
  box-shadow:var(--sh); transition:box-shadow .2s, border-color .2s;
  animation:fu .4s ease both;
}
.hero:hover { box-shadow:var(--sh2); border-color:var(--bord2); }
.hero-title {
  font-family:var(--serif); font-size:clamp(1.1rem,3.2vw,1.6rem);
  font-weight:700; line-height:1.25; letter-spacing:-.02em;
  margin-bottom:.6rem; color:var(--txt); transition:color .15s;
}
.hero:hover .hero-title { color:var(--it); }
.hero.eu:hover  .hero-title { color:var(--eu); }
.hero.usa:hover .hero-title { color:var(--usa); }
.hero-sum {
  font-family:var(--sans); font-size:.88rem; font-weight:300;
  line-height:1.75; color:var(--txt2); margin-bottom:.85rem;
}
.cmeta {
  font-family:var(--sans); font-size:.67rem; color:var(--muted);
  display:flex; gap:.7rem; flex-wrap:wrap; align-items:center;
}
.cmeta .src { color:var(--txt2); font-weight:600; }
.sep { color:var(--bord2); }

@keyframes fu { from{opacity:0;transform:translateY(7px)} to{opacity:1;transform:translateY(0)} }

/* â”€â”€ News grid â”€â”€ */
.ngrid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(265px,1fr));
  gap:1px; background:var(--bord);
  border:1px solid var(--bord); border-radius:var(--r);
  overflow:hidden; margin-bottom:1rem;
}
.ncard {
  background:var(--surf); padding:1.15rem; cursor:pointer;
  transition:background .15s; animation:fu .4s ease both;
}
.ncard:hover { background:var(--bg2); }
.ncard:hover .c-title { color:var(--it); }
.ncard.eu:hover  .c-title { color:var(--eu); }
.ncard.usa:hover .c-title { color:var(--usa); }
.c-title {
  font-family:var(--serif); font-size:.9rem; font-weight:700;
  line-height:1.4; margin:.4rem 0 .48rem; color:var(--txt); transition:color .15s;
}
.c-exc {
  font-family:var(--sans); font-size:.77rem; font-weight:300;
  color:var(--txt2); line-height:1.6; margin-bottom:.65rem;
  display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
}

/* â”€â”€ Source chips â”€â”€ */
.src-row { display:flex; flex-wrap:wrap; gap:.32rem; margin-bottom:.25rem; }
.src-chip {
  font-family:var(--sans); font-size:.61rem; font-weight:500;
  padding:.17rem .5rem; border:1px solid var(--bord);
  border-radius:20px; color:var(--muted); background:var(--surf);
}

/* â”€â”€ Footer â”€â”€ */
.footer {
  font-family:var(--sans); font-size:.67rem; color:var(--muted);
  text-align:center; padding:1.8rem 0 1rem;
  border-top:1px solid var(--bord); margin-top:2.5rem; line-height:2.2;
}
.footer a { color:var(--it); cursor:pointer; text-decoration:none; }
.footer a:hover { text-decoration:underline; }

/* â”€â”€ Modal â”€â”€ */
.modal-ov {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,.5); z-index:200;
  align-items:flex-end; justify-content:center;
}
@media(min-width:640px) { .modal-ov { align-items:center; padding:2rem; } }
.modal-ov.open { display:flex; }
.mbox {
  background:var(--surf); border-radius:14px 14px 0 0; width:100%;
  max-height:90vh; overflow-y:auto; padding:1.5rem 1.5rem 3rem;
  position:relative; border-top:3px solid var(--it); animation:slideUp .3s ease;
}
.mbox.eu  { border-top-color:var(--eu); }
.mbox.usa { border-top-color:var(--usa); }
@media(min-width:640px) {
  .mbox {
    max-width:640px; border-radius:var(--r);
    padding:2rem 2.25rem 2.5rem; animation:fu .25s ease;
  }
}
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.m-close {
  position:absolute; top:1rem; right:1rem;
  background:var(--bg2); border:1px solid var(--bord); border-radius:50%;
  width:32px; height:32px; display:flex; align-items:center; justify-content:center;
  font-size:.9rem; color:var(--muted); cursor:pointer;
}
.m-close:hover { color:var(--txt); }
.m-title {
  font-family:var(--serif); font-size:clamp(1.1rem,3.8vw,1.5rem);
  font-weight:700; line-height:1.3; letter-spacing:-.02em; margin:.65rem 0;
}
.m-meta {
  font-family:var(--sans); font-size:.7rem; color:var(--muted);
  margin-bottom:1.1rem; padding-bottom:1.1rem; border-bottom:1px solid var(--bord);
}
.m-body { font-family:var(--sans); font-size:.87rem; font-weight:300; line-height:1.8; color:var(--txt2); }
.m-body p { margin-bottom:.85rem; }
.m-link {
  display:inline-block; margin-top:1.1rem;
  font-family:var(--sans); font-size:.73rem; font-weight:600;
  color:var(--it); text-decoration:none; border-bottom:1px solid currentColor; padding-bottom:2px;
}
.m-link.eu  { color:var(--eu); }
.m-link.usa { color:var(--usa); }

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:640px) {
  main { padding:1.2rem 1rem; }
  .h-wrap { padding:0 1rem; }
  .hero { padding:1.15rem; }
  .ncard { padding:1rem; }
  .ngrid { grid-template-columns:1fr; }
  #status-txt, .s-dot { display:none; }
  .r-label { display:none; }
  .refresh-btn { padding:.42rem .7rem; }
}
@media(max-width:380px) {
  .brand { font-size:1.05rem; }
  .tab { font-size:.66rem; padding:.58rem .68rem .52rem; }
}
</style>
</head>
<body>

<header>
  <div class="h-wrap">
    <div class="h-top">
      <div class="brand">Minuto<span class="dot">.</span>Politico</div>
      <div class="h-ctrl">
        <span class="s-dot"></span>
        <span id="status-txt">â€”</span>
        <div class="theme-toggle" role="group" aria-label="Tema">
          <button class="t-btn" data-t="light" onclick="setTheme('light')" title="Chiaro">â˜€</button>
          <button class="t-btn active" data-t="auto"  onclick="setTheme('auto')"  title="Auto">â—</button>
          <button class="t-btn" data-t="dark"  onclick="setTheme('dark')"  title="Scuro">â˜¾</button>
        </div>
        <button class="refresh-btn" id="refresh-btn" onclick="refresh()" disabled>
          <span class="r-icon">â†»</span><span class="r-label">Aggiorna</span>
        </button>
      </div>
    </div>
    <nav class="tabs" role="tablist">
      <button class="tab active" data-cat="all" onclick="setTab(this)">Tutto</button>
      <button class="tab" data-cat="it"  onclick="setTab(this)">Italia</button>
      <button class="tab" data-cat="eu"  onclick="setTab(this)">Europa</button>
      <button class="tab" data-cat="usa" onclick="setTab(this)">USA</button>
    </nav>
  </div>
</header>

<main>
  <div id="loading">
    <div class="l-logo">Minuto<span class="dot">.</span>Politico</div>
    <div class="prog"><div class="prog-fill"></div></div>
    <div class="l-msg" id="l-msg">Caricamento feedâ€¦</div>
  </div>
  <div id="error">
    <div class="e-icon">ğŸ“¡</div>
    <div class="e-title">Nessuna notizia caricata</div>
    <div class="e-msg" id="e-msg">
      Impossibile raggiungere i feed RSS. Se apri il file localmente (file://), il browser blocca le richieste di rete.<br><br>
      <strong>Soluzione gratuita:</strong> trascina il file su <strong>netlify.com/drop</strong> per avere un link https:// che funziona sempre.
    </div>
    <button class="btn-retry" onclick="loadAll()">â†» Riprova</button>
  </div>
  <div id="content"></div>
</main>

<div class="modal-ov" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="mbox" id="mbox">
    <button class="m-close" onclick="closeModal()" aria-label="Chiudi">âœ•</button>
    <div id="m-tag"></div>
    <div class="m-title" id="m-title"></div>
    <div class="m-meta"  id="m-meta"></div>
    <div class="m-body"  id="m-body"></div>
    <a class="m-link" id="m-link" href="#" target="_blank" rel="noopener">Leggi l'articolo completo â†’</a>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIGURAZIONE FEED
   Ogni fonte contribuisce con le sue
   ultime N notizie (round-robin).
   Il Post integrato come fonte normale
   in ogni sezione tematica.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FEEDS = {
  it: [
    { name:'ANSA',           url:'https://www.ansa.it/sito/notizie/politica/politica_rss.xml',               lang:'it' },
    { name:'Corriere',       url:'https://xml2.corriereobjects.it/rss/politica.xml',                         lang:'it' },
    { name:'Repubblica',     url:'https://www.repubblica.it/rss/politica/rss2.0.xml',                        lang:'it' },
    { name:'Il Post',        url:'https://www.ilpost.it/politica/feed/',                                     lang:'it' },
    { name:'Il Sole 24 Ore', url:'https://www.ilsole24ore.com/rss/politica--italia.xml',                     lang:'it' },
    { name:'La Stampa',      url:'https://www.lastampa.it/rss/politica.xml',                                 lang:'it' },
    { name:'Il Fatto',       url:'https://www.ilfattoquotidiano.it/category/politica/feed/',                  lang:'it' },
    { name:'Il Foglio',      url:'https://www.ilfoglio.it/rss/politica/',                                    lang:'it' },
    { name:'HuffPost IT',    url:'https://www.huffingtonpost.it/feeds/index.xml',                            lang:'it' },
    { name:'Open',           url:'https://www.open.online/category/politica/feed/',                          lang:'it' },
  ],
  eu: [
    { name:'Euractiv',        url:'https://www.euractiv.com/sections/eu-politics/feed/',                     lang:'en' },
    { name:'Politico EU',     url:'https://www.politico.eu/feed/',                                           lang:'en' },
    { name:'EUobserver',      url:'https://euobserver.com/rss.xml',                                          lang:'en' },
    { name:'Il Post Esteri',  url:'https://www.ilpost.it/esteri/feed/',                                      lang:'it' },
    { name:'ANSA Europa',     url:'https://www.ansa.it/sito/notizie/mondo/europa/europa_rss.xml',            lang:'it' },
    { name:'Rep. Esteri',     url:'https://www.repubblica.it/rss/esteri/rss2.0.xml',                         lang:'it' },
    { name:'Corriere Esteri', url:'https://xml2.corriereobjects.it/rss/esteri.xml',                          lang:'it' },
    { name:'La Stampa Mondo', url:'https://www.lastampa.it/rss/esteri.xml',                                  lang:'it' },
  ],
  usa: [
    { name:'Politico',        url:'https://www.politico.com/rss/politics08.xml',                             lang:'en' },
    { name:'NPR Politics',    url:'https://feeds.npr.org/1014/rss.xml',                                      lang:'en' },
    { name:'AP Politics',     url:'https://feeds.apnews.com/rss/apf-politics',                               lang:'en' },
    { name:'The Hill',        url:'https://thehill.com/rss/syndicator/19109',                                 lang:'en' },
    { name:'Il Post USA',     url:'https://www.ilpost.it/tag/stati-uniti/feed/',                             lang:'it' },
    { name:'ANSA Americhe',   url:'https://www.ansa.it/sito/notizie/mondo/americhe/americhe_rss.xml',        lang:'it' },
    { name:'Corriere USA',    url:'https://xml2.corriereobjects.it/rss/esteri.xml',                          lang:'it' },
  ]
};

/* Quante notizie prendere per fonte â€” bilancia i volumi */
const PER_SOURCE = 2;

const PROXY     = 'https://api.rss2json.com/v1/api.json?rss_url=';
const CACHE_KEY = 'mp_v1';
const CACHE_TTL = 15 * 60 * 1000;

/* Dizionario di traduzioni rapide per titoli/sommari in inglese.
   Usiamo l'API Web Translation (MyMemory, gratuita, no key necessaria)
   per tradurre on-the-fly le notizie in inglese.
   Limitata a ~5000 caratteri/giorno, sufficiente per uso personale. */
const transCache = {};

async function translateText(text, sourceLang) {
  if (sourceLang !== 'en' || !text) return { text, translated: false };
  const cacheKey = text.slice(0, 80);
  if (transCache[cacheKey]) return transCache[cacheKey];
  try {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text.slice(0,500))}&langpair=en|it`;
    const r = await fetch(url);
    const d = await r.json();
    if (d.responseStatus === 200) {
      const result = { text: d.responseData.translatedText, translated: true };
      transCache[cacheKey] = result;
      return result;
    }
  } catch {}
  return { text, translated: false };
}

let allNews    = { it:[], eu:[], usa:[], ts:0 };
let currentTab = 'all';

/* â”€â”€ THEME â”€â”€ */
function initTheme() {
  const t = localStorage.getItem('mp_theme') || 'auto';
  applyTheme(t);
}
function setTheme(t) { applyTheme(t); localStorage.setItem('mp_theme', t); }
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.querySelectorAll('.t-btn').forEach(b => b.classList.toggle('active', b.dataset.t === t));
}

/* â”€â”€ INIT â”€â”€ */
window.onload = () => {
  initTheme();
  const c = getCache();
  if (c) { allNews = c; render(); } else loadAll();
};

/* â”€â”€ FETCH SINGOLO FEED â”€â”€
   Restituisce al massimo PER_SOURCE articoli per fonte,
   giÃ  con traduzione se necessario. */
async function fetchFeed(feed, cat) {
  try {
    const r = await fetch(PROXY + encodeURIComponent(feed.url));
    if (!r.ok) return [];
    const d = await r.json();
    if (d.status !== 'ok' || !d.items?.length) return [];

    const items = d.items.slice(0, PER_SOURCE);
    const results = [];

    for (const item of items) {
      let rawTitle   = clean(item.title || '');
      let rawSummary = clean(item.description || item.content || '').slice(0, 300);

      // Traduzione se necessaria
      let titleText   = rawTitle;
      let summaryText = rawSummary + 'â€¦';
      let translated  = false;

      if (feed.lang === 'en') {
        const [tTitle, tSumm] = await Promise.all([
          translateText(rawTitle, 'en'),
          translateText(rawSummary, 'en')
        ]);
        titleText   = tTitle.text;
        summaryText = tSumm.text.trimEnd() + 'â€¦';
        translated  = tTitle.translated;
      }

      results.push({
        cat, source: feed.name, lang: feed.lang,
        title:      titleText,
        summary:    summaryText,
        link:       item.link || '#',
        pubDate:    item.pubDate || '',
        time:       timeAgo(item.pubDate),
        translated
      });
    }
    return results;
  } catch { return []; }
}

/* â”€â”€ LOAD ALL â”€â”€
   Carica tutti i feed per categoria, poi esegue
   un interleave round-robin per dare visibilitÃ  uguale
   a ogni fonte, indipendentemente dal volume di pubblicazione. */
async function loadAll() {
  showState('loading');
  const btn = document.getElementById('refresh-btn');
  btn.disabled = true; btn.classList.add('loading');

  const labels = { it:'Italia', eu:'Europa', usa:'USA' };
  const groups  = { it:[], eu:[], usa:[] };

  for (const [cat, feeds] of Object.entries(FEEDS)) {
    setMsg(`Carico ${labels[cat]}â€¦`);
    const settled = await Promise.allSettled(feeds.map(f => fetchFeed(f, cat)));
    // Array di array â€” una per fonte
    const perSource = settled.map(r => r.status === 'fulfilled' ? r.value : []);
    // Round-robin interleave
    groups[cat] = roundRobin(perSource);
  }

  const total = Object.values(groups).reduce((s,a)=>s+a.length,0);
  if (!total) { showState('error'); btn.disabled=false; btn.classList.remove('loading'); return; }

  allNews = { ...groups, ts: Date.now() };
  setCache(allNews); render();
}

/* Round-robin: prende 1 articolo per volta da ogni fonte a turno.
   In questo modo nessuna fonte domina sul totale. */
function roundRobin(arrays) {
  const result = [];
  const seen   = new Set();
  const queues = arrays.map(a => [...a]);
  let   active = true;
  while (active) {
    active = false;
    for (const q of queues) {
      while (q.length) {
        const item = q.shift();
        const key  = item.title.slice(0,55).toLowerCase();
        if (!seen.has(key)) { seen.add(key); result.push(item); active = true; break; }
      }
    }
  }
  return result;
}

function refresh() { localStorage.removeItem(CACHE_KEY); loadAll(); }

/* â”€â”€ RENDER â”€â”€ */
function render() {
  showState('content');
  const btn = document.getElementById('refresh-btn');
  btn.disabled = false; btn.classList.remove('loading');
  const ago = Math.round((Date.now()-allNews.ts)/60000);
  document.getElementById('status-txt').textContent = ago < 1 ? 'adesso' : `${ago}m fa`;

  const showIt  = currentTab==='all'||currentTab==='it';
  const showEU  = currentTab==='all'||currentTab==='eu';
  const showUSA = currentTab==='all'||currentTab==='usa';

  let html = '';
  if (showIt  && allNews.it.length)  html += buildSection(allNews.it,  'it',  'IT',  'Italia',         FEEDS.it);
  if (showEU  && allNews.eu.length)  html += buildSection(allNews.eu,  'eu',  'EU',  'Europa',          FEEDS.eu);
  if (showUSA && allNews.usa.length) html += buildSection(allNews.usa, 'usa', 'USA', 'Stati Uniti',     FEEDS.usa);

  const d = new Date(allNews.ts);
  const allSrcs = [...new Set([...FEEDS.it,...FEEDS.eu,...FEEDS.usa].map(f=>f.name))];
  html += `<div class="footer">
    Aggiornato alle <strong>${d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})}</strong>
    Â· Cache 15 min Â· <a onclick="refresh()">Forza aggiornamento</a><br>
    Fonti: ${allSrcs.join(' Â· ')}
  </div>`;

  document.getElementById('content').innerHTML = html;
}

function buildSection(items, cat, iconLabel, label, feedList) {
  const [hero,...rest] = items;
  const srcNames = [...new Set(items.map(i=>i.source))];
  let h = `
  <div class="sec-hd ${cat}">
    <span class="sec-icon ${cat}">${iconLabel}</span>
    <span class="sec-title">${label}</span>
    <span class="sec-line"></span>
    <span class="sec-count">${items.length} notizie Â· ${srcNames.length} fonti</span>
  </div>
  ${heroTpl(hero)}`;

  if (rest.length) {
    h += `<div class="ngrid">`;
    rest.slice(0,11).forEach((n,i) => h += cardTpl(n,i));
    h += `</div>`;
  }
  h += `<div class="src-row">${srcNames.map(s=>`<span class="src-chip">${s}</span>`).join('')}</div>`;
  return h;
}

/* â”€â”€ TEMPLATES â”€â”€ */
function transBadge(item) {
  return item.translated ? `<span class="trans-badge">tradotto</span>` : '';
}
function heroTpl(n) {
  const e = enc(n);
  return `<div class="hero ${n.cat}" onclick="openM('${e}')">
    <span class="sbadge ${n.cat}">${n.source}</span>${transBadge(n)}
    <div class="hero-title">${n.title}</div>
    <div class="hero-sum">${n.summary}</div>
    <div class="cmeta"><span class="src">${n.source}</span><span class="sep">Â·</span><span>${n.time}</span></div>
  </div>`;
}
function cardTpl(n,i) {
  const e = enc(n);
  return `<div class="ncard ${n.cat}" style="animation-delay:${i*.05}s" onclick="openM('${e}')">
    <span class="sbadge ${n.cat}">${n.source}</span>${transBadge(n)}
    <div class="c-title">${n.title}</div>
    <div class="c-exc">${n.summary}</div>
    <div class="cmeta"><span class="src">${n.source}</span><span class="sep">Â·</span><span>${n.time}</span></div>
  </div>`;
}

/* â”€â”€ MODAL â”€â”€ */
function openM(encoded) {
  const n = JSON.parse(atob(encoded));
  document.getElementById('mbox').className = `mbox ${n.cat}`;
  document.getElementById('m-tag').innerHTML = `<span class="sbadge ${n.cat}">${n.source}</span>${transBadge(n)}`;
  document.getElementById('m-title').textContent = n.title;
  document.getElementById('m-meta').innerHTML = `<strong>${n.source}</strong> Â· ${n.time}`;
  document.getElementById('m-body').innerHTML = `<p>${n.summary}</p>`;
  const l = document.getElementById('m-link');
  l.href = n.link; l.className = `m-link ${n.cat}`;
  document.getElementById('modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal() {
  document.getElementById('modal').classList.remove('open');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

/* â”€â”€ TABS â”€â”€ */
function setTab(btn) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active'); currentTab = btn.dataset.cat;
  if (allNews.ts) render();
}

/* â”€â”€ STATE â”€â”€ */
function showState(s) {
  document.getElementById('loading').style.display = s==='loading' ? 'flex'  : 'none';
  document.getElementById('error').style.display   = s==='error'   ? 'flex'  : 'none';
  document.getElementById('content').style.display = s==='content' ? 'block' : 'none';
}
function setMsg(t) { document.getElementById('l-msg').textContent = t; }

/* â”€â”€ UTILS â”€â”€ */
function clean(s) {
  return s.replace(/<[^>]*>/g,'')
    .replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').replace(/&lt;/g,'<')
    .replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'")
    .replace(/\[&#8230;\]/g,'â€¦').replace(/\s+/g,' ').trim();
}
function timeAgo(ds) {
  if (!ds) return 'â€”';
  const diff = (Date.now()-new Date(ds))/1000;
  if (diff<60)    return 'adesso';
  if (diff<3600)  return `${Math.round(diff/60)}m fa`;
  if (diff<86400) return `${Math.round(diff/3600)}h fa`;
  return `${Math.round(diff/86400)}g fa`;
}
function enc(obj) {
  try { return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
  catch { return btoa(JSON.stringify(obj)); }
}
function setCache(d) { try { localStorage.setItem(CACHE_KEY,JSON.stringify(d)); } catch {} }
function getCache() {
  try {
    const d = JSON.parse(localStorage.getItem(CACHE_KEY));
    return (!d||Date.now()-d.ts>CACHE_TTL) ? null : d;
  } catch { return null; }
}
</script>
</body>
</html>
